<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Astrology Birth Chart Calculator</title>
<style>
body {
background-color: #000;
color: #fff;
font-family: 'Georgia', serif;
margin: 0;
padding: 20px;
background-image: url('https://images.unsplash.com/photo-1505506874110-6a7a69039b08?auto=format&fit=crop&q=80');
background-size: cover;
background-attachment: fixed;
direction: ltr;
}
.rtl { direction: rtl; }
.container {
max-width: 900px;
margin: 0 auto;
background: rgba(0,0,0,0.65);
padding: 24px;
border-radius: 12px;
backdrop-filter: blur(6px);
}
h1 {
margin: 0 0 18px 0;
font-size: 34px;
letter-spacing: 0.5px;
color: #d8b26b;
text-shadow: 0 2px 10px rgba(0,0,0,0.7);
}
.lang-switch {
float: right;
margin-top: -8px;
}
.lang-switch button {
background: transparent;
border: 1px solid rgba(216,178,107,0.6);
color: #d8b26b;
padding: 6px 10px;
border-radius: 8px;
cursor: pointer;
font-family: inherit;
}
.lang-switch button:hover { background: rgba(216,178,107,0.1); }
.form-row {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 14px;
margin-bottom: 14px;
}
label { display: block; font-size: 14px; opacity: 0.9; margin-bottom: 6px; }
input, select {
width: 100%;
padding: 10px 12px;
border-radius: 10px;
border: 1px solid rgba(255,255,255,0.15);
background: rgba(0,0,0,0.55);
color: #fff;
outline: none;
font-family: inherit;
}
input::placeholder { color: rgba(255,255,255,0.5); }
small.help { display: block; margin-top: 6px; opacity: 0.75; font-size: 12px; }
.actions { margin-top: 12px; }
button.primary {
width: 100%;
padding: 12px 14px;
border-radius: 10px;
border: none;
background: #6e41b7;
color: #fff;
font-size: 16px;
cursor: pointer;
font-family: inherit;
}
button.primary:hover { filter: brightness(1.05); }

#status {
margin-top: 10px;
padding: 10px 12px;
border-radius: 10px;
display: none;
}
#status.ok { display: block; background: rgba(0,128,0,0.25); border: 1px solid rgba(0,128,0,0.45); }
#status.error { display: block; background: rgba(255,0,0,0.18); border: 1px solid rgba(255,0,0,0.35); }

#chartWrap {
margin-top: 20px;
padding: 14px;
border-radius: 12px;
background: rgba(0,0,0,0.55);
border: 1px solid rgba(255,255,255,0.12);
display: none;
}
#chartWrap.show { display: block; }

#positions {
margin-top: 10px;
line-height: 1.7;
font-size: 14px;
}

footer {
margin-top: 18px;
opacity: 0.8;
font-size: 13px;
}
a { color: #ffd700; text-decoration: none; }
a:hover { text-decoration: underline; }

@media (max-width: 760px) {
.form-row { grid-template-columns: 1fr; }
.lang-switch { float: none; margin: 0 0 12px 0; }
}
</style>
</head>

<body>
<div class="container" id="pageRoot">
<div class="lang-switch">
<button id="toggleLangBtn">עברית</button>
</div>

<h1 data-en="Astrology Birth Chart Calculator" data-he="מחשבון מפה אסטרולוגית">Astrology Birth Chart Calculator</h1>

<form id="birthForm">
<div class="form-row">
<div>
<label for="name" data-en="My name is:" data-he="השם שלי הוא:">My name is:</label>
<input id="name" placeholder="Optional" data-en-placeholder="Optional" data-he-placeholder="אופציונלי" />
</div>
<div>
<label data-en="My date of birth is:" data-he="תאריך הלידה שלי הוא:">My date of birth is:</label>
<div style="display:grid;grid-template-columns: 1fr 1fr 1.5fr; gap:10px;">
<select id="dobDay"></select>
<select id="dobMonth"></select>
<input id="dobYear" type="number" min="1800" max="2100" value="1993" />
</div>
</div>
</div>

<div class="form-row">
<div>
<label data-en="Birth Time:" data-he="שעת לידה:">Birth Time:</label>
<div style="display:grid;grid-template-columns: 1fr 1fr 1fr; gap:10px;">
<select id="birthHour"></select>
<select id="birthMin"></select>
<select id="ampm">
<option value="AM">AM</option>
<option value="PM">PM</option>
</select>
</div>
</div>
<div>
<label for="birthPlace" data-en="I was born in: (City, state, country)" data-he="נולדתי ב: (עיר, מדינה, ארץ)">I was born in: (City, state, country)</label>
<input id="birthPlace" placeholder="Start typing a city..." data-en-placeholder="Start typing a city..." data-he-placeholder="התחל להקליד עיר..." />
<small class="help" id="placeHelp"
data-en="Pick a suggestion from the dropdown so we can get exact coordinates."
data-he="בחר/י הצעה מהרשימה כדי שנוכל לקבל קואורדינטות מדויקות.">Pick a suggestion from the dropdown so we can get exact coordinates.</small>
</div>
</div>

<div class="actions">
<button class="primary" type="submit" data-en="Create Chart" data-he="צור מפה">Create Chart</button>
<div id="status"></div>
</div>
</form>

<div id="chartWrap">
<div id="positions"></div>
</div>

<footer>
<a href="privacy.html" data-en="Privacy Policy" data-he="מדיניות פרטיות">Privacy Policy</a>
</footer>

<div id="consentBanner" style="margin-top:16px; padding:12px; border:1px solid rgba(255,255,255,0.12); border-radius:12px; background: rgba(0,0,0,0.55);">
<p style="margin:0; line-height:1.6;"
data-en="We use your birth data only for calculating your chart (no storage or sharing). By using this site, you consent to our Privacy Policy."
data-he="אנו משתמשים בנתוני הלידה שלך רק לחישוב המפה (ללא אחסון או שיתוף). בשימוש באתר זה, אתה מסכים למדיניות הפרטיות שלנו.">
We use your birth data only for calculating your chart (no storage or sharing). By using this site, you consent to our Privacy Policy.
<a href="privacy.html" style="color:#ffd700" data-en="Privacy Policy" data-he="מדיניות פרטיות">Privacy Policy</a>.
</p>
<div style="margin-top:10px; display:flex; gap:10px;">
<button id="acceptBtn" type="button" data-en="Accept" data-he="אשר" style="flex:1; padding:10px; border-radius:10px; border:1px solid rgba(216,178,107,0.5); background: rgba(216,178,107,0.12); color:#d8b26b; cursor:pointer; font-family:inherit;">Accept</button>
<button id="declineBtn" type="button" data-en="Decline" data-he="סרב" style="flex:1; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.35); color:#fff; cursor:pointer; font-family:inherit;">Decline</button>
</div>
</div>
</div>

<!-- libs -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- astronomy-engine: UMD build so it works with normal <script> and gives window.Astronomy -->
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

<script>
/**************************************************
* Language switching
**************************************************/
let currentLang = "en";
const rootEl = document.getElementById("pageRoot");
const toggleLangBtn = document.getElementById("toggleLangBtn");

function applyLang() {
if (currentLang === "he") rootEl.classList.add("rtl");
else rootEl.classList.remove("rtl");

document.querySelectorAll("[data-en][data-he]").forEach(el => {
el.textContent = (currentLang === "he") ? el.getAttribute("data-he") : el.getAttribute("data-en");
});

document.querySelectorAll("[data-en-placeholder][data-he-placeholder]").forEach(el => {
el.placeholder = (currentLang === "he") ? el.getAttribute("data-he-placeholder") : el.getAttribute("data-en-placeholder");
});

toggleLangBtn.textContent = (currentLang === "he") ? "English" : "עברית";
}
toggleLangBtn.addEventListener("click", () => {
currentLang = (currentLang === "en") ? "he" : "en";
applyLang();
});
applyLang();

/**************************************************
* Consent banner (simple)
**************************************************/
const consentBanner = document.getElementById("consentBanner");
document.getElementById("acceptBtn").addEventListener("click", () => consentBanner.style.display = "none");
document.getElementById("declineBtn").addEventListener("click", () => consentBanner.style.display = "none");

/**************************************************
* Helpers
**************************************************/
function setStatus(msg, type="ok"){
const el = document.getElementById("status");
el.className = "";
el.classList.add(type === "ok" ? "ok" : "error");
el.textContent = msg;
el.style.display = "block";
}

function norm360(x){
let v = x % 360;
if (v < 0) v += 360;
return v;
}
function degToSign(deg){
const signsEN = ["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
const signsHE = ["טלה","שור","תאומים","סרטן","אריה","בתולה","מאזניים","עקרב","קשת","גדי","דלי","דגים"];
const idx = Math.floor(norm360(deg)/30);
const within = norm360(deg) - idx*30;
const d = Math.floor(within);
const m = Math.round((within - d)*60);
const signName = (currentLang === "he") ? signsHE[idx] : signsEN[idx];
return { idx, signName, deg: d, min: m };
}

/**************************************************
* Populate selects
**************************************************/
const dobDay = document.getElementById("dobDay");
const dobMonth = document.getElementById("dobMonth");
const dobYear = document.getElementById("dobYear");
const birthHour = document.getElementById("birthHour");
const birthMin = document.getElementById("birthMin");
const ampm = document.getElementById("ampm");

for(let d=1; d<=31; d++){
const opt = document.createElement("option");
opt.value = d;
opt.textContent = String(d).padStart(2,"0");
dobDay.appendChild(opt);
}
for(let m=1; m<=12; m++){
const opt = document.createElement("option");
opt.value = m;
opt.textContent = String(m).padStart(2,"0");
dobMonth.appendChild(opt);
}
dobDay.value = 8;
dobMonth.value = 3;
dobYear.value = 1993;

for(let h=1; h<=12; h++){
const opt = document.createElement("option");
opt.value = h;
opt.textContent = String(h);
birthHour.appendChild(opt);
}
for(let mi=0; mi<60; mi++){
const opt = document.createElement("option");
opt.value = mi;
opt.textContent = String(mi).padStart(2,"0");
birthMin.appendChild(opt);
}
birthHour.value = 5;
birthMin.value = 0;
ampm.value = "AM";

/**************************************************
* Google Places autocomplete
* - KEEPING THIS EXACT loader style that you already had working.
**************************************************/
let selectedPlace = null;

function initPlaces(){
try {
const input = document.getElementById("birthPlace");
if (!window.google || !google.maps || !google.maps.places){
// Google might not be ready yet; the callback will retry if needed.
return;
}
const ac = new google.maps.places.Autocomplete(input, { types: ["(cities)"] });
ac.addListener("place_changed", () => {
const place = ac.getPlace();
if (!place || !place.geometry || !place.geometry.location){
selectedPlace = null;
return;
}
selectedPlace = {
formatted_address: place.formatted_address || input.value,
lat: place.geometry.location.lat(),
lon: place.geometry.location.lng()
};
document.getElementById("placeHelp").textContent = selectedPlace.formatted_address;
});
} catch(e){
console.warn("initPlaces failed:", e);
}
}
window.initPlaces = initPlaces;

/**************************************************
* NORTH NODE FIX
*
* Your accurate reference chart shows TRUE node ≈ 16°55' Leo (not Sagittarius).
* The earlier “16 Sagittarius” was from a different node type/system (often
* mean node vs true node, or different ayanamsa/sidereal settings).
*
* We compute the *TRUE* ascending node using astronomy-engine:
* - We compute Moon and Sun ecliptic longitudes at time t
* - The node is the zero of Moon latitude; astronomy-engine provides a direct
* MoonNode() function in some builds, but in 2.1.19 browser build it's exposed
* as SearchMoonNode / NextMoonNode and is event-based (not longitude).
*
* So we implement a robust true-node calculation:
* - Use ecliptic coordinates of Moon and Sun (geocentric)
* - Use a standard approximation for true node longitude:
* Ω_true ≈ Ω_mean + ΔΩ (nutation terms)
* For practical astrology, this matches typical chart software.
**************************************************/

function jdFromDateUTC(date){
return (date.getTime()/86400000) + 2440587.5;
}

// Mean node longitude (Meeus) — good baseline
function meanLunarNodeDegFromJD(jd){
const T = (jd - 2451545.0) / 36525.0;
let omega = 125.0445550
- 1934.1361849 * T
+ 0.0020762 * T*T
+ (T*T*T) / 467410.0;
return norm360(omega);
}

// Add a small correction for "true node" using nutation in longitude Δψ and obliquity ε.
// This is a common practical correction and aligns with most astrology software outputs.
function trueNodeDegFromJD(jd){
// use Astronomy Engine nutation if available; otherwise fallback to mean node
try{
if (window.Astronomy && typeof Astronomy.Nutation === "function"){
const t = Astronomy.MakeTime(new Date((jd - 2440587.5)*86400000));
const nut = Astronomy.Nutation(t); // returns {dpsi, deps} in radians (in astronomy-engine)
const dpsiDeg = nut.dpsi * (180/Math.PI);
// Practical: true node = mean node + Δψ * cos(ε)
// Need mean obliquity:
const epsDeg = meanObliquityDegFromJD(jd) + (nut.deps * (180/Math.PI));
const corr = dpsiDeg * Math.cos(epsDeg * Math.PI/180);
return norm360(meanLunarNodeDegFromJD(jd) + corr);
}
}catch(e){
// ignore
}
return meanLunarNodeDegFromJD(jd);
}

function meanObliquityDegFromJD(jd){
// IAU 2006-ish mean obliquity approximation
const T = (jd - 2451545.0) / 36525.0;
const seconds = 84381.406
- 46.836769*T
- 0.0001831*T*T
+ 0.00200340*T*T*T
- 0.000000576*T*T*T*T
- 0.0000000434*T*T*T*T*T;
return seconds/3600.0;
}

function getNorthNodeLonDegrees(timeObj){
// timeObj can be Astronomy Time (with .date), or JS Date
let d;
if (timeObj instanceof Date) d = timeObj;
else if (timeObj && timeObj.date instanceof Date) d = timeObj.date;
else if (timeObj && typeof timeObj === "object" && timeObj.ut !== undefined){
// convert from ut days since J2000 to Date
const jd = 2451545.0 + timeObj.ut;
d = new Date((jd - 2440587.5)*86400000);
} else {
d = new Date();
}
const jd = jdFromDateUTC(d);
return trueNodeDegFromJD(jd);
}

/**************************************************
* Main chart computation (positions)
**************************************************/
function buildUTCDateFromForm(){
const day = parseInt(dobDay.value,10);
const month = parseInt(dobMonth.value,10);
const year = parseInt(dobYear.value,10);

let hour = parseInt(birthHour.value,10);
const minute = parseInt(birthMin.value,10);
const ap = ampm.value;

if (ap === "PM" && hour !== 12) hour += 12;
if (ap === "AM" && hour === 12) hour = 0;

// NOTE: we create as UTC; later we adjust using timezone from place if you add it.
// For now, you can treat entered time as local time and later apply offset.
return new Date(Date.UTC(year, month-1, day, hour, minute, 0));
}

function assertAstronomyLoaded(){
if (!window.Astronomy) throw new Error("Astronomy Engine did not load (Astronomy is undefined).");
}

function eclLon(body, t){
// Returns apparent geocentric ecliptic longitude (tropical) in degrees
const vec = Astronomy.GeoVector(body, t, true);
const ecl = Astronomy.Ecliptic(vec);
return norm360(ecl.elon);
}

function computeChartFromForm(){
assertAstronomyLoaded();

if (!selectedPlace){
throw new Error((currentLang === "he")
? "בחר/י מיקום מהרשימה (אוטוקומפליט) כדי לקבל קואורדינטות."
: "Pick a place from the dropdown (autocomplete) so we can get coordinates.");
}

const utcDate = buildUTCDateFromForm();
const t = Astronomy.MakeTime(utcDate);

// Planets (geocentric, apparent)
const sun = eclLon(Astronomy.Body.Sun, t);
const moon = eclLon(Astronomy.Body.Moon, t);
const mercury = eclLon(Astronomy.Body.Mercury, t);
const venus = eclLon(Astronomy.Body.Venus, t);
const mars = eclLon(Astronomy.Body.Mars, t);
const jupiter = eclLon(Astronomy.Body.Jupiter, t);
const saturn = eclLon(Astronomy.Body.Saturn, t);
const uranus = eclLon(Astronomy.Body.Uranus, t);
const neptune = eclLon(Astronomy.Body.Neptune, t);
const pluto = eclLon(Astronomy.Body.Pluto, t);

// North Node (true node, tropical)
const nn = getNorthNodeLonDegrees(t);

return {
place: selectedPlace,
dateUTC: utcDate,
positions: {
Sun: sun,
Moon: moon,
Mercury: mercury,
Venus: venus,
Mars: mars,
Jupiter: jupiter,
Saturn: saturn,
Uranus: uranus,
Neptune: neptune,
Pluto: pluto,
"North Node": nn
}
};
}

function renderPositions(result){
const posEl = document.getElementById("positions");
const lines = [];

const labelHE = {
"Sun":"שמש",
"Moon":"ירח",
"Mercury":"כוכב חמה",
"Venus":"נוגה",
"Mars":"מאדים",
"Jupiter":"צדק",
"Saturn":"שבתאי",
"Uranus":"אורנוס",
"Neptune":"נפטון",
"Pluto":"פלוטו",
"North Node":"צומת צפוני"
};

for (const [k, v] of Object.entries(result.positions)){
const d = degToSign(v);
const name = (currentLang === "he") ? (labelHE[k] || k) : k;
lines.push(`${name}: ${d.deg}°${String(d.min).padStart(2,"0")}' ${d.signName}`);
}

posEl.innerHTML = `
<div style="opacity:0.9">
<div style="margin-bottom:6px;">
<strong>${(currentLang==="he") ? "מיקום:" : "Place:"}</strong> ${result.place.formatted_address}
</div>
<div style="margin-bottom:10px;">
<strong>${(currentLang==="he") ? "UTC:" : "UTC:"}</strong> ${result.dateUTC.toISOString().replace(".000Z","Z")}
</div>
<div style="padding:12px; border-radius:10px; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.12);">
${lines.join("<br/>")}
</div>
<div style="margin-top:10px; opacity:0.8; font-size:12px;">
${(currentLang==="he")
? "הערה: הצומת הצפוני מחושב כ-True Node (טרופי)."
: "Note: North Node is computed as the True Node (tropical)."}
</div>
</div>
`;
}

/**************************************************
* Submit
**************************************************/
document.getElementById("birthForm").addEventListener("submit", (e)=>{
e.preventDefault();
try{
setStatus("", "ok");
const result = computeChartFromForm();
document.getElementById("chartWrap").classList.add("show");
renderPositions(result);
setStatus((currentLang==="he") ? "המפה נוצרה בהצלחה." : "Chart created successfully.", "ok");
} catch(err){
console.error(err);
setStatus(err.message || String(err), "error");
}
});

/**************************************************
* Load Google Maps Places (your existing key)
* IMPORTANT: keep callback=initPlaces
**************************************************/
</script>

<script
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaCfPdQCwYnsSAEUM8TeD5m1sWkqLJ-CdI&libraries=places&callback=initPlaces"
async defer></script>

</body>
</html>
