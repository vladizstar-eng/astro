<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Astrology Birth Chart Calculator</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
--bg:#0b0b12;
--panel:#151524;
--panel2:#0f0f1a;
--text:#f2f2f5;
--muted:#b9b9c6;
--accent:#7c3aed;
--accent2:#a78bfa;
--danger:#ef4444;
--ok:#22c55e;
--gold:#eab308;
}

html,body{height:100%;}
body{
margin:0;
background:radial-gradient(1000px 600px at 20% 10%, #1b1b34, transparent 60%),
radial-gradient(900px 500px at 80% 20%, #2a1340, transparent 60%),
var(--bg);
color:var(--text);
font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.wrap{
max-width:1100px;
margin:0 auto;
padding:28px 18px 60px;
display:grid;
grid-template-columns: 380px 1fr;
gap:22px;
align-items:start;
}

header{
grid-column:1 / -1;
display:flex;
justify-content:space-between;
align-items:center;
gap:12px;
margin-bottom:8px;
}

h1{
margin:0;
font-family:Cinzel, serif;
font-weight:600;
letter-spacing:.02em;
color:#f6d38a;
text-shadow:0 0 18px rgba(124,58,237,.25);
font-size:28px;
}

.langToggle{
display:flex;
gap:8px;
align-items:center;
background:rgba(255,255,255,.06);
border:1px solid rgba(255,255,255,.12);
border-radius:999px;
padding:6px 10px;
font-size:13px;
color:var(--muted);
user-select:none;
}

.langToggle button{
background:transparent;
border:0;
color:var(--muted);
font-weight:600;
padding:4px 10px;
border-radius:999px;
cursor:pointer;
}
.langToggle button.active{
background:rgba(124,58,237,.35);
color:white;
}

.card{
background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
border:1px solid rgba(255,255,255,.10);
border-radius:18px;
padding:16px;
box-shadow: 0 10px 24px rgba(0,0,0,.35);
}

.formRow{margin:14px 0;}
label{
display:block;
margin:0 0 6px;
font-size:13px;
color:var(--muted);
}

input, select{
width:100%;
box-sizing:border-box;
border-radius:12px;
border:1px solid rgba(255,255,255,.14);
background:rgba(0,0,0,.22);
color:var(--text);
padding:10px 12px;
font-size:14px;
outline:none;
}
input:focus,select:focus{
border-color:rgba(167,139,250,.65);
box-shadow:0 0 0 4px rgba(124,58,237,.22);
}

.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
.gridTime{display:grid;grid-template-columns:1fr 1fr 1.1fr;gap:10px;}

.hint{font-size:12px;color:rgba(255,255,255,.65);line-height:1.3;margin-top:6px;}
.btn{
width:100%;
margin-top:16px;
background:linear-gradient(90deg, rgba(124,58,237,.95), rgba(167,139,250,.95));
border:0;
color:white;
font-weight:700;
padding:12px 14px;
border-radius:14px;
cursor:pointer;
font-size:15px;
box-shadow:0 12px 22px rgba(124,58,237,.25);
}
.btn:hover{filter:brightness(1.05);}
.btn:active{transform:translateY(1px);}

.status{
margin-top:10px;
font-size:13px;
color:rgba(255,255,255,.75);
min-height:18px;
}
.status.error{color:#fecaca;}
.status.ok{color:#bbf7d0;}

#chartCard{
min-height:560px;
display:flex;
flex-direction:column;
gap:10px;
}

#chart{
width:100%;
flex:1;
border-radius:14px;
background:rgba(0,0,0,.20);
border:1px solid rgba(255,255,255,.10);
overflow:hidden;
position:relative;
}

#chart svg{
width:100%;
height:100%;
display:block;
}

.small{
font-size:12px;
color:rgba(255,255,255,.68);
}

footer{
margin-top:14px;
font-size:12px;
color:rgba(255,255,255,.55);
}

@media(max-width:980px){
.wrap{grid-template-columns:1fr;}
#chartCard{min-height:520px;}
}

/* RTL tweaks when Hebrew active */
body[dir="rtl"] .wrap{direction:rtl;}
body[dir="rtl"] label{text-align:right;}
body[dir="rtl"] .hint{text-align:right;}
</style>
</head>

<body>
<div class="wrap">
<header>
<h1 data-en="Astrology Birth Chart Calculator" data-he="מחשבון מפה אסטרולוגית">Astrology Birth Chart Calculator</h1>
<div class="langToggle" aria-label="Language">
<button id="langEN" class="active" type="button">EN</button>
<button id="langHE" type="button">עברית</button>
</div>
</header>

<div class="card">
<form id="birthForm">
<div class="formRow">
<label for="name" data-en="My name is:" data-he="השם שלי הוא:">My name is:</label>
<input id="name" type="text" placeholder="Optional" />
</div>

<div class="formRow">
<label data-en="My date of birth is:" data-he="תאריך הלידה שלי הוא:">My date of birth is:</label>
<div class="grid3">
<select id="day"></select>
<select id="month"></select>
<input id="year" type="number" min="1800" max="2200" value="1993" />
</div>
</div>

<div class="formRow">
<label data-en="Birth Time:" data-he="שעת לידה:">Birth Time:</label>
<div class="gridTime">
<select id="hour"></select>
<select id="minute"></select>
<select id="ampm">
<option value="AM">AM</option>
<option value="PM">PM</option>
</select>
</div>
</div>

<div class="formRow">
<label for="place" data-en="I was born in: (City, state, country)" data-he="נולדתי ב: (עיר, מדינה, ארץ)">I was born in: (City, state, country)</label>
<input id="place" type="text" placeholder="e.g., Donetsk, Ukraine" autocomplete="off" />
<div class="hint" data-en="Pick a suggestion from the dropdown so we can get exact coordinates."
data-he="בחר/י הצעה מהרשימה כדי שנוכל לקבל קואורדינטות מדויקות.">
Pick a suggestion from the dropdown so we can get exact coordinates.
</div>
<div id="placePicked" class="small"></div>
</div>

<button class="btn" type="submit" data-en="Create Chart" data-he="צור מפה">Create Chart</button>
<div id="status" class="status"></div>
</form>

<footer>
<a href="privacy.html" data-en="Privacy Policy" data-he="מדיניות פרטיות">Privacy Policy</a>
</footer>

<div id="consentBanner">
<p data-en="We use your birth data only for calculating your chart (no storage or sharing). By using this site, you consent to our Privacy Policy."
data-he="אנו משתמשים בנתוני הלידה שלך רק לחישוב המפה שלך (ללא אחסון או שיתוף). בשימוש באתר זה, אתה מסכים למדיניות הפרטיות שלנו.">
We use your birth data only for calculating your chart (no storage or sharing). By using this site, you consent to our Privacy Policy.
<a href="privacy.html" style="color:#ffd700">Privacy Policy</a>.
</p>
<button id="acceptBtn" data-en="Accept" data-he="אשר">Accept</button>
<button id="declineBtn" data-en="Decline" data-he="סרב">Decline</button>
</div>

<!-- libs -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Astronomy Engine as ESM -->
<script type="module">
import * as Astronomy from "https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.3/+esm";
window.Astronomy = Astronomy;
</script>
</div>

<div class="card" id="chartCard">
<div class="small" id="chartTitle"></div>
<div id="chart"></div>
<div class="small" id="positionsText"></div>
</div>
</div>

<script>
/****************************************
* Helpers & Globals
****************************************/
const statusEl = document.getElementById('status');
const chartEl = document.getElementById('chart');
const chartTitleEl = document.getElementById('chartTitle');
const positionsTextEl = document.getElementById('positionsText');

let pickedLat = null;
let pickedLon = null;
let pickedLabel = null;

function setStatus(msg, type=""){
statusEl.textContent = msg || "";
statusEl.className = "status " + (type || "");
}

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

function norm360(deg){
deg = deg % 360;
return deg < 0 ? deg + 360 : deg;
}

function degToSign(deg){
const signs = ["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
const d = norm360(deg);
const si = Math.floor(d / 30);
const within = d - si*30;
const dd = Math.floor(within);
const mm = Math.round((within - dd)*60);
return { sign: signs[si], deg: dd, min: mm };
}

function signToHeb(sign){
const map = {
Aries:"טלה", Taurus:"שור", Gemini:"תאומים", Cancer:"סרטן", Leo:"אריה", Virgo:"בתולה",
Libra:"מאזניים", Scorpio:"עקרב", Sagittarius:"קשת", Capricorn:"גדי", Aquarius:"דלי", Pisces:"דגים"
};
return map[sign] || sign;
}

function fmtPos(label, lonDeg, lang="en"){
const p = degToSign(lonDeg);
if(lang==="he"){
return `${label}: ${p.deg}°${String(p.min).padStart(2,"0")} ${signToHeb(p.sign)}`;
}
return `${label}: ${p.deg}°${String(p.min).padStart(2,"0")} ${p.sign}`;
}

/****************************************
* Julian Day + Node helpers
****************************************/
function jdFromAstroTime(time){
// Astronomy Engine Time has .ut = days since J2000
if (time && typeof time.ut === 'number') return 2451545.0 + time.ut;
if (time instanceof Date) return (time.getTime()/86400000) + 2440587.5;
throw new Error("Cannot compute JD from time object");
}

// Mean lunar ascending node longitude (Ω) in degrees (tropical), Meeus-style approximation.
function meanLunarNodeDegFromJD(jd){
const T = (jd - 2451545.0) / 36525.0;
let omega = 125.0445550
- 1934.1361849 * T
+ 0.0020762 * T*T
+ (T*T*T) / 467410.0;
return norm360(omega);
}

// Get North Node (ascending node) ecliptic longitude in degrees (tropical).
// Astronomy Engine v2.x does not expose a direct MoonNode() API in the browser build,
// so we use the robust fallback: mean ascending node longitude from Julian Day.
function getNodeLon(time){
const jd = jdFromAstroTime(time);
return meanLunarNodeDegFromJD(jd);
}

function meanObliquityDeg(time) {
// Mean obliquity of the ecliptic (ε0) in degrees (Meeus).
const jd = jdFromAstroTime(time);
const T = (jd - 2451545.0) / 36525.0;

const seconds =
21.448
- 46.8150 * T
- 0.00059 * T * T
+ 0.001813 * T * T * T;

const eps = 23.0 + 26.0/60.0 + seconds/3600.0;
return eps;
}

function localSiderealTimeDeg(time, lonDeg){
// Astronomy.SiderealTime(time) returns sidereal hours at Greenwich
const gstHours = Astronomy.SiderealTime(time);
const lst = norm360(gstHours*15 + lonDeg);
return lst;
}

/****************************************
* UI setup (date/time dropdowns)
****************************************/
(function initDropdowns(){
const daySel = document.getElementById("day");
const monthSel = document.getElementById("month");
const hourSel = document.getElementById("hour");
const minuteSel = document.getElementById("minute");

for(let d=1; d<=31; d++){
const o=document.createElement("option");
o.value=d; o.textContent=String(d).padStart(2,"0");
daySel.appendChild(o);
}
const months = ["01","02","03","04","05","06","07","08","09","10","11","12"];
months.forEach((m,i)=>{
const o=document.createElement("option");
o.value=i+1; o.textContent=m;
monthSel.appendChild(o);
});

for(let h=1; h<=12; h++){
const o=document.createElement("option");
o.value=h; o.textContent=String(h);
hourSel.appendChild(o);
}
for(let m=0; m<60; m++){
const o=document.createElement("option");
o.value=m; o.textContent=String(m).padStart(2,"0");
minuteSel.appendChild(o);
}

// Defaults for your natal data
daySel.value = 8;
monthSel.value = 3;
document.getElementById("year").value = 1993;
hourSel.value = 5;
minuteSel.value = 0;
document.getElementById("ampm").value = "AM";
})();

/****************************************
* Language toggle
****************************************/
let currentLang = "en";
const langEN = document.getElementById("langEN");
const langHE = document.getElementById("langHE");

function applyLang(lang){
currentLang = lang;
document.body.setAttribute("dir", lang==="he" ? "rtl" : "ltr");

langEN.classList.toggle("active", lang==="en");
langHE.classList.toggle("active", lang==="he");

document.querySelectorAll("[data-en]").forEach(el=>{
el.textContent = el.getAttribute(lang==="he" ? "data-he" : "data-en");
});

// Also update button labels
document.querySelectorAll("button[data-en]").forEach(el=>{
el.textContent = el.getAttribute(lang==="he" ? "data-he" : "data-en");
});
}

langEN.addEventListener("click", ()=>applyLang("en"));
langHE.addEventListener("click", ()=>applyLang("he"));

/****************************************
* Google Places Autocomplete (optional)
****************************************/
let autocomplete = null;
function initPlaces(){
if(!window.google || !google.maps || !google.maps.places) return;

const input = document.getElementById("place");
autocomplete = new google.maps.places.Autocomplete(input, { types: ["(cities)"] });

autocomplete.addListener("place_changed", ()=>{
const p = autocomplete.getPlace();
if(!p || !p.geometry) return;

pickedLat = p.geometry.location.lat();
pickedLon = p.geometry.location.lng();
pickedLabel = p.formatted_address || p.name || input.value;

document.getElementById("placePicked").textContent = pickedLabel;
setStatus("", "");
});
}

/****************************************
* Chart Computation
****************************************/
function assertAstronomyLoaded(){
if(!window.Astronomy){
throw new Error("Astronomy Engine did not load (Astronomy is undefined). Check that the CDN URL is reachable.");
}
}

function makeAstroTimeUTC(year,month,day,hour24,minute){
// Construct a UTC Date then convert to Astronomy Time.
const dateUTC = new Date(Date.UTC(year, month-1, day, hour24, minute, 0));
return Astronomy.MakeTime(dateUTC);
}

function computeChartFromForm(){
assertAstronomyLoaded();

const year = parseInt(document.getElementById("year").value, 10);
const month = parseInt(document.getElementById("month").value, 10);
const day = parseInt(document.getElementById("day").value, 10);

const hour12 = parseInt(document.getElementById("hour").value, 10);
const minute = parseInt(document.getElementById("minute").value, 10);
const ampm = document.getElementById("ampm").value;

let hour24 = hour12 % 12;
if(ampm === "PM") hour24 += 12;

if(pickedLat == null || pickedLon == null){
throw new Error(currentLang==="he"
? "בחר/י מקום מהרשימה כדי לקבל קואורדינטות מדויקות."
: "Pick a place suggestion so we can get exact coordinates.");
}

const time = makeAstroTimeUTC(year,month,day,hour24,minute);

// Planetary longitudes (geocentric apparent ecliptic of date, J2000? Astronomy-engine returns of-date)
const bodies = [
["Sun", "Sun"],
["Moon", "Moon"],
["Mercury","Mercury"],
["Venus","Venus"],
["Mars","Mars"],
["Jupiter","Jupiter"],
["Saturn","Saturn"],
["Uranus","Uranus"],
["Neptune","Neptune"],
["Pluto","Pluto"],
];

const positions = [];

for(const [label, bodyName] of bodies){
const vec = Astronomy.GeoVector(bodyName, time, true);
const ecl = Astronomy.Ecliptic(vec);
positions.push({ label, lon: norm360(ecl.elon) });
}

// North Node (mean) in tropical ecliptic longitude
const nodeLon = getNodeLon(time);
positions.push({ label: currentLang==="he" ? "צומת צפוני" : "North Node", lon: nodeLon });

// (Optional) You can add South Node if you want:
// positions.push({ label: currentLang==="he" ? "צומת דרומי" : "South Node", lon: norm360(nodeLon + 180) });

// Simple text output
const name = (document.getElementById("name").value || "").trim();
const title = name ? (currentLang==="he" ? `מפה עבור ${name}` : `Chart for ${name}`) : (currentLang==="he" ? "המפה שלך" : "Your chart");
chartTitleEl.textContent = title;

const lines = positions.map(p => fmtPos(p.label, p.lon, currentLang));
positionsTextEl.textContent = lines.join(" • ");

// Draw a simple wheel
drawWheel(positions);

return positions;
}

/****************************************
* Simple D3 Chart Rendering
****************************************/
function drawWheel(positions){
chartEl.innerHTML = "";
const w = chartEl.clientWidth;
const h = Math.max(520, chartEl.clientHeight || 520);
const size = Math.min(w, h);
const r = size/2 - 20;

const svg = d3.select(chartEl)
.append("svg")
.attr("viewBox", `0 0 ${size} ${size}`);

const g = svg.append("g")
.attr("transform", `translate(${size/2},${size/2})`);

// outer ring
g.append("circle")
.attr("r", r)
.attr("fill", "rgba(0,0,0,0.15)")
.attr("stroke", "rgba(255,255,255,0.18)")
.attr("stroke-width", 2);

// zodiac lines every 30°
for(let i=0;i<12;i++){
const ang = (i*30 - 90) * Math.PI/180;
g.append("line")
.attr("x1", Math.cos(ang)*(r-5))
.attr("y1", Math.sin(ang)*(r-5))
.attr("x2", Math.cos(ang)*(r-70))
.attr("y2", Math.sin(ang)*(r-70))
.attr("stroke", "rgba(255,255,255,0.12)")
.attr("stroke-width", 2);
}

// points
positions.forEach((p, idx)=>{
const ang = (p.lon - 90) * Math.PI/180;
const pr = r-30;
const x = Math.cos(ang)*pr;
const y = Math.sin(ang)*pr;

g.append("circle")
.attr("cx", x)
.attr("cy", y)
.attr("r", 6)
.attr("fill", idx===positions.length-1 ? "rgba(234,179,8,0.95)" : "rgba(167,139,250,0.95)")
.attr("stroke", "rgba(0,0,0,0.45)")
.attr("stroke-width", 1.5);

g.append("text")
.attr("x", x)
.attr("y", y - 10)
.attr("text-anchor", "middle")
.attr("font-size", 11)
.attr("fill", "rgba(255,255,255,0.85)")
.text(p.label);
});
}

/****************************************
* Form submit
****************************************/
document.getElementById("birthForm").addEventListener("submit", (e)=>{
e.preventDefault();
try{
setStatus("");
const positions = computeChartFromForm();
setStatus(currentLang==="he" ? "המפה נוצרה בהצלחה" : "Chart created successfully", "ok");
} catch(err){
console.error(err);
setStatus(err.message || String(err), "error");
}
});

/****************************************
* Try init Google Places if Maps loaded
****************************************/
window.initPlaces = initPlaces;
</script>

<!-- Google Places loader (you already have your key here) -->
<script
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaCfPdQCwYnssAEUM8TeDsm1sWKqLJ-CQ&libraries=places&callback=initPlaces"
async defer></script>

</body>
</html>
